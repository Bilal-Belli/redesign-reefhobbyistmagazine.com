<!DOCTYPE html>
<html>

  <head>
    <title>Admin â€“ Members</title>
    <link rel="icon" type="image/png" href="/img/favicon.ico">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="/style/admin.css" />
    <style>
      .pagination .page-link {
        cursor: pointer;
      }
      .page-info {
        font-size: 0.9rem;
        color: #6c757d;
      }
    </style>
  </head>

  <body class="bg-light">
    <!-- ================= NAVBAR ================= -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-black">
      <div class="container">
        <a class="navbar-brand" href="/admin"><img src="../img/logo.jpg" alt="Magazine Logo" class="img-fluid"></a>
        <button class="navbar-toggler" data-bs-toggle="collapse" data-bs-target="#nav">
          <span class="navbar-toggler-icon"></span>
        </button>
        <div id="nav" class="collapse navbar-collapse">
          <ul class="navbar-nav ms-auto">
            <li class="nav-item btn btn-outline-warning btn-sm mx-4"><a class="nav-link active" href="/admin">Admin Home</a></li>
          </ul>
        </div>
      </div>
    </nav>

    <!-- ================= DASHBOARD ================= -->
    <div class="container-fluid px-4 py-4">
      <h2 class="mb-4">ðŸ‘¥ Manage Members</h2>
      <!-- Search and Filter -->
      <div class="row mb-3">
        <div class="col-md-6">
          <div class="input-group">
            <input type="text" class="form-control" id="searchInput" placeholder="Search by email, country, or ID...">
            <button class="btn btn-outline-secondary" type="button" onclick="searchMembers()">Search</button>
            <button class="btn btn-outline-secondary" type="button" onclick="clearSearch()">Clear</button>
          </div>
        </div>
        <div class="col-md-3">
        </div>
        <div class="col-md-3">
          <select class="form-select" id="itemsPerPage" onchange="changeItemsPerPage()">
            <option value="10">10 per page</option>
            <option value="25" selected>25 per page</option>
            <option value="50">50 per page</option>
            <option value="100">100 per page</option>
          </select>
        </div>
      </div>
      <div class="card shadow-sm">
        <div class="card-body">
          <div class="table-responsive">
            <table class="table table-bordered table-hover align-middle">
              <thead class="table-dark">
                <tr>
                  <th>ID</th>
                  <th>Email</th>
                  <th>Country</th>
                  <th>Registration</th>
                  <th>Activation</th>
                  <th>Status</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="membersTable"></tbody>
            </table>
          </div>
          <!-- Pagination -->
          <div class="d-flex justify-content-between align-items-center mt-3">
            <div class="page-info" id="pageInfo"></div>
            <nav>
              <ul class="pagination mb-0" id="pagination"></ul>
            </nav>
          </div>
        </div>
      </div>
    </div>

    <!-- ================= EDIT MODAL ================= -->
    <div class="modal fade" id="editModal">
      <div class="modal-dialog">
        <form id="editForm" class="modal-content">
          <div class="modal-header">
            <h5>Edit Member</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <input type="hidden" name="id">
            <input type="email" name="email" class="form-control mb-3" placeholder="Email" required>
            <input type="text" name="country" class="form-control mb-3" placeholder="Country" required>
            <input type="date" name="registration" class="form-control mb-3" placeholder="Registration Date" required>
            <input type="date" name="activation" class="form-control mb-3" placeholder="Activation Date">
            <select name="status" class="form-select mb-3">
              <option value="active">Active</option>
              <option value="inactive">Inactive</option>
              <option value="pending">Pending</option>
            </select>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            <button type="submit" class="btn btn-primary">Save Changes</button>
          </div>
        </form>
      </div>
    </div>

    <footer>
      <div class="container text-center">
        <p>All Rights Reserved. Copyright Â©
          <script>document.write(new Date().getFullYear())</script> Reef Hobbyist Magazine
        </p>
      </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      // ================= PAGINATION VARIABLES =================
      let allMembers = [];
      let filteredMembers = [];
      let currentPage = 1;
      let itemsPerPage = 10;
      let totalPages = 1;
      let searchTerm = '';
      let statusFilter = '';

      // ================= DOM ELEMENTS =================
      const table = document.getElementById("membersTable");
      const pagination = document.getElementById("pagination");
      const pageInfo = document.getElementById("pageInfo");

      // ================= LOAD ALL MEMBERS =================
      async function loadMembers() {
        try {
          const res = await fetch("/api/admin/members");
          allMembers = await res.json();
          // Sort by registration date (newest first) or ID
          allMembers.sort((a, b) => {
            if (a.registration && b.registration) {
              return new Date(b.registration) - new Date(a.registration);
            }
            return b.id.localeCompare(a.id);
          });
          applyFilters();
          renderTable();
          updatePagination();
        } catch (error) {
          console.error("Error loading members:", error);
          table.innerHTML = `<tr><td colspan="7" class="text-center text-danger">Failed to load members</td></tr>`;
        }
      }

      // ================= APPLY FILTERS =================
      function applyFilters() {
        filteredMembers = allMembers.filter(member => {
          // Apply search filter
          if (searchTerm) {
            const searchLower = searchTerm.toLowerCase();
            if (!member.id.toLowerCase().includes(searchLower) &&
              !member.email.toLowerCase().includes(searchLower) &&
              !member.country.toLowerCase().includes(searchLower)) {
              return false;
            }
          }
          // Apply status filter
          if (statusFilter && member.status !== statusFilter) {
            return false;
          }
          return true;
        });
        currentPage = 1; // Reset to first page when filters change
        totalPages = Math.ceil(filteredMembers.length / itemsPerPage);
      }

      // ================= RENDER TABLE =================
      function renderTable() {
        if (filteredMembers.length === 0) {
          table.innerHTML = `<tr><td colspan="7" class="text-center">No members found</td></tr>`;
          return;
        }
        const startIndex = (currentPage - 1) * itemsPerPage;
        const endIndex = Math.min(startIndex + itemsPerPage, filteredMembers.length);
        const pageMembers = filteredMembers.slice(startIndex, endIndex);
        table.innerHTML = "";
        pageMembers.forEach(m => {
          const tr = document.createElement("tr");
          // Format dates for display
          const formatDate = (dateStr) => {
            if (!dateStr) return "";
            try {
              const date = new Date(dateStr);
              return date.toLocaleDateString();
            } catch {
              return dateStr;
            }
          };
          // Status badge
          const statusClass = m.status === 'active' ? 'badge bg-success' :
            m.status === 'inactive' ? 'badge bg-danger' :
              'badge bg-warning';
          tr.innerHTML = `
            <td><strong>${m.id}</strong></td>
            <td>${m.email}</td>
            <td>${m.country}</td>
            <td>${formatDate(m.registration)}</td>
            <td>${formatDate(m.activation)}</td>
            <td><span class="${statusClass}">${m.status}</span></td>
            <td>
              <button class="btn btn-sm btn-outline-secondary" onclick="openEdit('${m.id}')">Edit</button>
              <button class="btn btn-sm btn-outline-danger" onclick="deleteMember('${m.id}')">Delete</button>
            </td>
          `;
          table.appendChild(tr);
        });
      }

      // ================= UPDATE PAGINATION CONTROLS =================
      function updatePagination() {
        pagination.innerHTML = "";
        if (totalPages <= 1) {
          pageInfo.textContent = `Showing ${filteredMembers.length} members`;
          return;
        }
        // Previous button
        const prevLi = document.createElement("li");
        prevLi.className = `page-item ${currentPage === 1 ? 'disabled' : ''}`;
        prevLi.innerHTML = `<a class="page-link" ${currentPage > 1 ? 'onclick="goToPage(' + (currentPage - 1) + ')"' : ''}>Previous</a>`;
        pagination.appendChild(prevLi);
        // Page numbers
        const maxVisiblePages = 5;
        let startPage = Math.max(1, currentPage - Math.floor(maxVisiblePages / 2));
        let endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);
        if (endPage - startPage + 1 < maxVisiblePages) {
          startPage = Math.max(1, endPage - maxVisiblePages + 1);
        }
        for (let i = startPage; i <= endPage; i++) {
          const li = document.createElement("li");
          li.className = `page-item ${i === currentPage ? 'active' : ''}`;
          li.innerHTML = `<a class="page-link" onclick="goToPage(${i})">${i}</a>`;
          pagination.appendChild(li);
        }
        // Next button
        const nextLi = document.createElement("li");
        nextLi.className = `page-item ${currentPage === totalPages ? 'disabled' : ''}`;
        nextLi.innerHTML = `<a class="page-link" ${currentPage < totalPages ? 'onclick="goToPage(' + (currentPage + 1) + ')"' : ''}>Next</a>`;
        pagination.appendChild(nextLi);
        // Page info
        const startIndex = (currentPage - 1) * itemsPerPage + 1;
        const endIndex = Math.min(currentPage * itemsPerPage, filteredMembers.length);
        pageInfo.textContent = `Showing ${startIndex}-${endIndex} of ${filteredMembers.length} members`;
      }

      // ================= PAGINATION FUNCTIONS =================
      function goToPage(page) {
        if (page < 1 || page > totalPages || page === currentPage) return;
        currentPage = page;
        renderTable();
        updatePagination();
        window.scrollTo({ top: 0, behavior: 'smooth' });
      }

      function changeItemsPerPage() {
        itemsPerPage = parseInt(document.getElementById("itemsPerPage").value);
        currentPage = 1;
        totalPages = Math.ceil(filteredMembers.length / itemsPerPage);
        renderTable();
        updatePagination();
      }

      // ================= SEARCH AND FILTER FUNCTIONS =================
      function searchMembers() {
        searchTerm = document.getElementById("searchInput").value.trim();
        applyFilters();
        renderTable();
        updatePagination();
      }

      function clearSearch() {
        document.getElementById("searchInput").value = "";
        searchTerm = "";
        applyFilters();
        renderTable();
        updatePagination();
      }

      function filterByStatus() {
        statusFilter = document.getElementById("statusFilter").value;
        applyFilters();
        renderTable();
        updatePagination();
      }

      // ================= EDIT MEMBER =================
      async function openEdit(id) {
        const m = allMembers.find(x => x.id === id);
        if (!m) {
          alert("Member not found");
          return;
        }
        const f = document.forms.editForm;
        f.id.value = m.id;
        f.email.value = m.email;
        f.country.value = m.country;
        // Format dates for date input (YYYY-MM-DD)
        const formatForDateInput = (dateStr) => {
          if (!dateStr) return "";
          try {
            const date = new Date(dateStr);
            return date.toISOString().split('T')[0];
          } catch {
            return dateStr;
          }
        };
        f.registration.value = formatForDateInput(m.registration);
        f.activation.value = formatForDateInput(m.activation);
        f.status.value = m.status;
        new bootstrap.Modal(document.getElementById("editModal")).show();
      }

      document.getElementById("editForm").addEventListener("submit", async e => {
        e.preventDefault();
        const id = e.target.id.value;
        const payload = {
          email: e.target.email.value,
          country: e.target.country.value,
          registration: e.target.registration.value,
          activation: e.target.activation.value,
          status: e.target.status.value
        };
        try {
          const res = await fetch("/api/admin/members/" + id, {
            method: "PATCH",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload)
          });
          const json = await res.json();
          if (json.success) {
            bootstrap.Modal.getInstance(document.getElementById("editModal")).hide();
            loadMembers(); // Reload all data
          } else {
            alert(json.error || "Update failed");
          }
        } catch (error) {
          alert("Network error: " + error.message);
        }
      });

      // ================= DELETE MEMBER =================
      async function deleteMember(id) {
        if (!confirm("Are you sure you want to delete this member?")) return;
        try {
          const res = await fetch("/api/admin/members/" + id, { method: "DELETE" });
          const json = await res.json();
          if (json.success) {
            loadMembers(); // Reload all data
          } else {
            alert(json.error || "Delete failed");
          }
        } catch (error) {
          alert("Network error: " + error.message);
        }
      }

      // ================= INITIALIZE =================
      document.addEventListener("DOMContentLoaded", function () {
        loadMembers();
        // Add keyboard shortcut for search
        document.getElementById("searchInput").addEventListener("keyup", function (e) {
          if (e.key === "Enter") {
            searchMembers();
          }
        });
      });
    </script>
  </body>
</html>